{"pageProps":{"slug":"jest-react","title":"Tìm hiểu về Jestjs, viết unit test cho javascript","date":"2022-03-05","description":"Jestjs là một JavaScript Testing Framework khá là dễ sử dụng và cài đặt, tuy nhiên vẫn đầy đủ tính năng để bạn có thể sử dụng. Bài viết này mình xin giới thiệu một số tính năng cơ bản của jest cùng với một số ví dụ.","tags":["reactjs"],"content":"<h1>Tìm hiểu về Jestjs, viết unit test cho javascript</h1>\n<p>Jestjs là một JavaScript Testing Framework khá là dễ sử dụng và cài đặt, tuy nhiên vẫn đầy đủ tính năng để bạn có thể sử dụng :clap:\nBài viết này mình xin giới thiệu một số tính năng cơ bản của jest cùng với một số ví dụ.</p>\n<h2>Cài đặt</h2>\n<p>Cài đặt Jest khá đơn giản:</p>\n<pre><code class=\"hljs language-bash\">yarn add --dev jest\n</code></pre>\n<p>hoặc</p>\n<pre><code class=\"hljs language-bash\">npm install --save-dev jest\n</code></pre>\n<p>Sau đó thêm đoạn code sau vào file package.json:</p>\n<pre><code class=\"hljs language-json\"><span class=\"hljs-punctuation\">{</span>\n  <span class=\"hljs-attr\">\"scripts\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">{</span>\n    <span class=\"hljs-attr\">\"test\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">\"jest\"</span>\n  <span class=\"hljs-punctuation\">}</span>\n<span class=\"hljs-punctuation\">}</span>\n</code></pre>\n<p>Tiếp theo mình có ví dụ một file test: <code>math.js</code></p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title hljs-function\">sum</span>(<span class=\"hljs-params\">a, b</span>) {\n  <span class=\"hljs-keyword\">return</span> a + b;\n}\n\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-title hljs-class\">MathJS</span> = {\n  sum,\n};\n\n<span class=\"hljs-variable hljs-language\">module</span>.<span class=\"hljs-property\">exports</span> = <span class=\"hljs-title hljs-class\">MathJS</span>;\n</code></pre>\n<p>Để viết test cho file trên mình tạo file <code>test/math.test.js</code>, đuôi file là test.js sẽ nói cho jest biết đây là file test của bạn.</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-title hljs-class\">MathJS</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">\"../math\"</span>);\n\n<span class=\"hljs-title hljs-function\">it</span>(<span class=\"hljs-string\">\"Adds 1 + 1 to equals 2\"</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-title hljs-function\">expect</span>(<span class=\"hljs-title hljs-class\">MathJS</span>.<span class=\"hljs-title hljs-function\">sum</span>(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">1</span>)).<span class=\"hljs-title hljs-function\">toBe</span>(<span class=\"hljs-number\">2</span>);\n});\n</code></pre>\n<p>Sau đó chạy <code>yarn test</code> hoặc <code>npm run test</code>.</p>\n<p><img src=\"https://images.viblo.asia/9692954e-c671-4dcd-b028-dc188e860bea.png\" alt=\"Kết quả\"></p>\n<h1>Các Matchers trong Jest</h1>\n<p>Ở trong đoạn code trên:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-title hljs-function\">expect</span>(<span class=\"hljs-title hljs-class\">MathJS</span>.<span class=\"hljs-title hljs-function\">sum</span>(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">1</span>)).<span class=\"hljs-title hljs-function\">toBe</span>(<span class=\"hljs-number\">2</span>);\n</code></pre>\n<p><code>.toBe()</code> chính là một matcher trong jest. Nó giống như phép so sánh bằng bình thường vậy. Ví dụ:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-title hljs-function\">expect</span>(result).<span class=\"hljs-title hljs-function\">toBe</span>(<span class=\"hljs-number\">2</span>);\n<span class=\"hljs-title hljs-function\">expect</span>(result).<span class=\"hljs-title hljs-function\">toBe</span>(<span class=\"hljs-literal\">true</span>);\n<span class=\"hljs-title hljs-function\">expect</span>(result).<span class=\"hljs-title hljs-function\">toBe</span>({ <span class=\"hljs-attr\">a</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-number\">2</span> });\n</code></pre>\n<p>Tuy nhiên khi so sánh một Object bạn nên sử dụng <code>.toEqual()</code>\nLý do là vì <code>.toBe</code> thực tế sử dụng <code>===</code> để so sánh và đưa ra kết quả. Và chúng ta đều biết trong javascript:</p>\n<pre><code class=\"hljs language-js\">a = {};\nb = {};\na === b;\n=> <span class=\"hljs-literal\">false</span>\n</code></pre>\n<p>Còn <code>.toEqual()</code> theo như Jest sẽ lần lượt kiểm tra tất các trường của Object, hoặc mảng để so sánh.\nVì vậy thay vì viết:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-title hljs-function\">expect</span>(result).<span class=\"hljs-title hljs-function\">toBe</span>({ <span class=\"hljs-attr\">a</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-number\">2</span> });\n</code></pre>\n<p>Hãy viết:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-title hljs-function\">expect</span>(result).<span class=\"hljs-title hljs-function\">toEqual</span>({ <span class=\"hljs-attr\">a</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-attr\">b</span>: <span class=\"hljs-number\">2</span> });\n</code></pre>\n<p>Ngoài ra còn các matchers khác:</p>\n<h3>Truthiness</h3>\n<ul>\n<li><code>toBeNull</code> so sánh với giá trị <code>null</code>.</li>\n<li><code>toBeUndefined</code> so sánh với giá trị <code>undefined</code>.</li>\n<li><code>toBeDefined</code> là hàm cho kết quả ngược lại <code>toBeUndefined</code>.</li>\n<li><code>toBeTruthy</code> so sánh với giá trị true.</li>\n<li><code>toBeFalsy</code> so sánh với giá trị false.</li>\n</ul>\n<h3>Numbers</h3>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-title hljs-function\">it</span>(<span class=\"hljs-string\">\"two plus two\"</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-keyword\">const</span> value = <span class=\"hljs-number\">2</span> + <span class=\"hljs-number\">2</span>;\n  <span class=\"hljs-title hljs-function\">expect</span>(value).<span class=\"hljs-title hljs-function\">toBeGreaterThan</span>(<span class=\"hljs-number\">3</span>);\n  <span class=\"hljs-title hljs-function\">expect</span>(value).<span class=\"hljs-title hljs-function\">toBeGreaterThanOrEqual</span>(<span class=\"hljs-number\">3.5</span>);\n  <span class=\"hljs-title hljs-function\">expect</span>(value).<span class=\"hljs-title hljs-function\">toBeLessThan</span>(<span class=\"hljs-number\">5</span>);\n  <span class=\"hljs-title hljs-function\">expect</span>(value).<span class=\"hljs-title hljs-function\">toBeLessThanOrEqual</span>(<span class=\"hljs-number\">4.5</span>);\n\n  <span class=\"hljs-comment\">// toBe and toEqual are equivalent for numbers</span>\n  <span class=\"hljs-title hljs-function\">expect</span>(value).<span class=\"hljs-title hljs-function\">toBe</span>(<span class=\"hljs-number\">4</span>);\n  <span class=\"hljs-title hljs-function\">expect</span>(value).<span class=\"hljs-title hljs-function\">toEqual</span>(<span class=\"hljs-number\">4</span>);\n});\n</code></pre>\n<p>Đối với số thập phân, bạn nên sử dụng <code>toBeCloseTo</code>:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-title hljs-function\">it</span>(<span class=\"hljs-string\">\"adding floating point numbers\"</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-keyword\">const</span> value = <span class=\"hljs-number\">0.1</span> + <span class=\"hljs-number\">0.2</span>;\n  <span class=\"hljs-comment\">//expect(value).toBe(0.3);           This won't work because of rounding error</span>\n  <span class=\"hljs-title hljs-function\">expect</span>(value).<span class=\"hljs-title hljs-function\">toBeCloseTo</span>(<span class=\"hljs-number\">0.3</span>); <span class=\"hljs-comment\">// This works.</span>\n});\n</code></pre>\n<h3>String</h3>\n<p>Bạn có thể kiểm tra một đoạn văn bản với regular expressions bằng <code>toMatch</code>:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-title hljs-function\">it</span>(<span class=\"hljs-string\">\"there is no I in team\"</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-title hljs-function\">expect</span>(<span class=\"hljs-string\">\"team\"</span>).<span class=\"hljs-property\">not</span>.<span class=\"hljs-title hljs-function\">toMatch</span>(<span class=\"hljs-regexp\">/I/</span>);\n});\n\n<span class=\"hljs-title hljs-function\">it</span>(<span class=\"hljs-string\">'but there is a \"stop\" in Christoph'</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-title hljs-function\">expect</span>(<span class=\"hljs-string\">\"Christoph\"</span>).<span class=\"hljs-title hljs-function\">toMatch</span>(<span class=\"hljs-regexp\">/stop/</span>);\n});\n</code></pre>\n<h3>Array</h3>\n<p>Để kiểm tra giá trị có trong một mảng, bạn có thể dùng toContain:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> array = [<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">10</span>, <span class=\"hljs-number\">1000</span>];\n<span class=\"hljs-title hljs-function\">it</span>(<span class=\"hljs-string\">\"array has 1000 on it\"</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-title hljs-function\">expect</span>(array).<span class=\"hljs-title hljs-function\">toContain</span>(<span class=\"hljs-number\">1000</span>);\n});\n</code></pre>\n<h3>Exceptions</h3>\n<p>Để kiểm tra một lỗi có thể xảy ra bạn có thể sử dụng <code>toThrow</code>:</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title hljs-function\">compileAndroidCode</span>(<span class=\"hljs-params\"></span>) {\n  <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title hljs-class\">ConfigError</span>(<span class=\"hljs-string\">\"you are using the wrong JDK\"</span>);\n}\n\n<span class=\"hljs-title hljs-function\">test</span>(<span class=\"hljs-string\">\"compiling android goes as expected\"</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-title hljs-function\">expect</span>(compileAndroidCode).<span class=\"hljs-title hljs-function\">toThrow</span>();\n  <span class=\"hljs-title hljs-function\">expect</span>(compileAndroidCode).<span class=\"hljs-title hljs-function\">toThrow</span>(<span class=\"hljs-title hljs-class\">ConfigError</span>);\n\n  <span class=\"hljs-comment\">// You can also use the exact error message or a regexp</span>\n  <span class=\"hljs-title hljs-function\">expect</span>(compileAndroidCode).<span class=\"hljs-title hljs-function\">toThrow</span>(<span class=\"hljs-string\">\"you are using the wrong JDK\"</span>);\n  <span class=\"hljs-title hljs-function\">expect</span>(compileAndroidCode).<span class=\"hljs-title hljs-function\">toThrow</span>(<span class=\"hljs-regexp\">/JDK/</span>);\n});\n</code></pre>\n<h1>Một số ví dụ</h1>\n<h2>Test một action trong redux</h2>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable hljs-constant\">CHANGE_EMAIL</span> = <span class=\"hljs-string\">\"CHANGE_EMAIL\"</span>;\n\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title hljs-function\">changeEmail</span>(<span class=\"hljs-params\">email</span>) {\n  <span class=\"hljs-keyword\">return</span> {\n    <span class=\"hljs-attr\">type</span>: <span class=\"hljs-variable hljs-constant\">CHANGE_EMAIL</span>,\n    email,\n  };\n}\n\n<span class=\"hljs-title hljs-function\">it</span>(<span class=\"hljs-string\">\"should render type and email of change email action\"</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-keyword\">const</span> email = <span class=\"hljs-string\">\"test@tt.com\"</span>;\n  <span class=\"hljs-keyword\">const</span> expected = {\n    <span class=\"hljs-attr\">type</span>: <span class=\"hljs-variable hljs-constant\">CHANGE_EMAIL</span>,\n    email,\n  };\n\n  <span class=\"hljs-title hljs-function\">expect</span>(<span class=\"hljs-title hljs-function\">changeEmail</span>(email)).<span class=\"hljs-title hljs-function\">toEqual</span>(expected);\n});\n</code></pre>\n<h2>Test một event trong Jquery</h2>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-title hljs-function\">it</span>(<span class=\"hljs-string\">\"should fire a alert\"</span>, <span class=\"hljs-function\">() =></span> {\n  <span class=\"hljs-keyword\">const</span> alert = jest.<span class=\"hljs-title hljs-function\">fn</span>();\n\n  <span class=\"hljs-variable hljs-language\">document</span>.<span class=\"hljs-property\">body</span>.<span class=\"hljs-property\">innerHTML</span> =\n    <span class=\"hljs-string\">\"&#x3C;div>\"</span> +\n    <span class=\"hljs-string\">'  &#x3C;span id=\"username\" />'</span> +\n    <span class=\"hljs-string\">'  &#x3C;button id=\"button\" />'</span> +\n    <span class=\"hljs-string\">\"&#x3C;/div>\"</span>;\n\n  $(<span class=\"hljs-string\">\"#button\"</span>).<span class=\"hljs-title hljs-function\">click</span>(<span class=\"hljs-function\">() =></span> {\n    <span class=\"hljs-title hljs-function\">alert</span>(<span class=\"hljs-string\">\"click\"</span>);\n  });\n\n  $(<span class=\"hljs-string\">\"#button\"</span>).<span class=\"hljs-title hljs-function\">click</span>();\n  <span class=\"hljs-title hljs-function\">expect</span>(alert).<span class=\"hljs-title hljs-function\">toBeCalled</span>();\n\n  <span class=\"hljs-comment\">// the mock function is called one time</span>\n  <span class=\"hljs-title hljs-function\">expect</span>(alert.<span class=\"hljs-property\">mock</span>.<span class=\"hljs-property\">calls</span>.<span class=\"hljs-property\">length</span>).<span class=\"hljs-title hljs-function\">toBe</span>(<span class=\"hljs-number\">1</span>);\n\n  <span class=\"hljs-comment\">// The first argument of the first call to the function was click</span>\n  <span class=\"hljs-title hljs-function\">expect</span>(alert.<span class=\"hljs-property\">mock</span>.<span class=\"hljs-property\">calls</span>[<span class=\"hljs-number\">0</span>][<span class=\"hljs-number\">0</span>]).<span class=\"hljs-title hljs-function\">toBe</span>(<span class=\"hljs-string\">\"click\"</span>);\n});\n</code></pre>\n<p>Bạn có thể thấy <code>const alert = jest.fn();</code>. Đây là một tính năng trong Jest giúp bạn mock một function. Hay mô phỏng lại hàm cần test.</p>\n<h2>Test với module axios</h2>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> axios = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">\"axios\"</span>);\n\njest.<span class=\"hljs-title hljs-function\">mock</span>(<span class=\"hljs-string\">\"axios\"</span>, <span class=\"hljs-function\">() =></span> ({\n  <span class=\"hljs-attr\">get</span>: jest.<span class=\"hljs-title hljs-function\">fn</span>().<span class=\"hljs-title hljs-function\">mockResolvedValue</span>({ <span class=\"hljs-attr\">data</span>: { <span class=\"hljs-attr\">message</span>: <span class=\"hljs-string\">\"hello\"</span> } }),\n}));\n\n<span class=\"hljs-title hljs-function\">test</span>(<span class=\"hljs-string\">\"mock axios.get\"</span>, <span class=\"hljs-keyword\">async</span> () => {\n  <span class=\"hljs-keyword\">const</span> response = <span class=\"hljs-keyword\">await</span> axios.<span class=\"hljs-title hljs-function\">get</span>(<span class=\"hljs-string\">\"https://test.com/t/1\"</span>);\n  <span class=\"hljs-title hljs-function\">expect</span>(response.<span class=\"hljs-property\">data</span>).<span class=\"hljs-title hljs-function\">toEqual</span>({ <span class=\"hljs-attr\">foo</span>: <span class=\"hljs-string\">\"bar\"</span> });\n});\n</code></pre>\n<p>Trong ví dụ này mình đã mock module axios, và đặt giá trị trả về cho hàm get. Như vậy khi test bạn sẽ không cần phải gửi request thật, tránh mất thời gian. Các module khác bạn cũng có thể làm cách tương tự.</p>"},"__N_SSG":true}